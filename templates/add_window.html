<!-- prettier-ignore -->
<div id="{{ window_id }}" class="system-window">
  {% if show_back_btn %}
    <div class="back-btn" onclick="switch_to_main_window()"></div>
  {% endif %}

  <form class="system-from" id="{{ form_id }}">
    <!-- hidden type field -->
    <input type="hidden" name="type" value="{{ route_name | default(form_id.replace('_form','')) }}">

    <label for="{{ input_name }}">{{ input_label }}</label>
    <input type="text" id="{{ input_name }}" name="{{ input_name }}" value="{{ input_value | default('') }}" />

    {% if show_number_inputs %}
      <label for="coin_reward">Coin reward</label>
      <input type="number" id="coin_reward" name="coin_reward" value="{{ coin_reward | default(2) }}" />

      <label for="xp_reward">XP reward</label>
      <input type="number" id="xp_reward" name="xp_reward" value="{{ xp_reward | default(2) }}" />
    {% endif %}

    {% if show_time_inputs %}
      <label for="start_time">Start time</label>
      <input type="time" id="start_time" name="start_time" />

      <label for="end_time">End time</label>
      <input type="time" id="end_time" name="end_time" />
    {% endif %}

    {% if show_repeat_days %}
      <fieldset>
        <legend>Repeat on (select days)</legend>
        {% for day in ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'] %}
          <label><input type="checkbox" name="repeat_days" value="{{ day }}" /> {{ day|capitalize }}</label>
        {% endfor %}
      </fieldset>
    {% endif %}

    <input type="submit" value="{{ submit_text | default('Submit') }}" />
  </form>
</div>
<script type="module">
  import {
    Task,
    Concecenses,
  } from "{{ url_for('static', filename='script/tasks.js') }}";
  import { switch_to_main_window } from "{{ url_for('static', filename='script/system_windows.js') }}";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("{{ form_id }}");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (form.id === "add_user_form") {
        await handleUserForm(form);
      } else if (form.id === "add_task_form") {
        await handleTaskForm(form);
      } else if (form.id === "add_concecenses_form") {
        await handleConcecensesForm(form);
      }
    });
  });

  async function handleUserForm(form) {
    const formData = new FormData(form);
    const response = await fetch("/api/add", {
      method: "POST",
      body: formData,
    });
    const result = await response.json();
    console.log("User form result:", result);
    switch_to_main_window();
    location.reload();
  }

  async function handleTaskForm(form) {
    const task_name = document.getElementById("task_name").value;
    const coin_reward = parseInt(document.getElementById("coin_reward").value);
    const xp_reward = parseInt(document.getElementById("xp_reward").value);
    const start_time = document.getElementById("start_time").value;
    const end_time = document.getElementById("end_time").value;
    const repeatDays = Array.from(
      document.querySelectorAll('input[name="repeat_days"]:checked')
    ).map((checkbox) => checkbox.value);

    const new_task = new Task(
      null,
      task_name,
      coin_reward,
      xp_reward,
      start_time,
      end_time,
      false,
      false,
      repeatDays
    );
    new_task.add_task();
    switch_to_main_window();
  }

  async function handleConcecensesForm(form) {
    const concecenses_name = document.getElementById("concecenses_name").value;
    const new_concecenses = new Concecenses("null", concecenses_name);
    new_concecenses.add_concecenses();
  }
</script>
